  const handleGenerateSummary = () => {
    const text = "üìä *RESUMO DE PRECIFICA√á√ÉO - 3D PRINT FLOW*\n" +
      "---------------------------------------\n" +
      "‚è±Ô∏è *Tempo de Impress√£o:* " + calcInputs.printingTime + "h\n" +
      "‚öñÔ∏è *Peso Estimado:* " + calcInputs.partWeight + "g (+ " + calcInputs.filamentLossPercentage + "% perda)\n" +
      "---------------------------------------\n" +
      "üí∞ *DETALHAMENTO DE CUSTOS:*\n" +
      "‚Ä¢ Material: " + formatCurrency(calcResults.materialCost) + "\n" +
      "‚Ä¢ Energia: " + formatCurrency(calcResults.energyCost) + "\n" +
      "‚Ä¢ M√£o de Obra: " + formatCurrency(calcResults.laborCost) + "\n" +
      "‚Ä¢ Manuten√ß√£o: " + formatCurrency(calcResults.maintenanceCost) + "\n" +
      "‚Ä¢ Custos Fixos: " + formatCurrency(calcResults.fixedRateCost) + "\n\n" +
      "üíµ *CUSTO TOTAL DE PRODU√á√ÉO:* " + formatCurrency(calcResults.subtotal) + "\n" +
      "üìà *MARGEM APLICADA:* " + calcInputs.profitMargin + "% (" + formatCurrency(calcResults.profit) + ")\n\n" +
      "üíé *VALOR FINAL SUGERIDO:* " + formatCurrency(calcResults.total) + "\n" +
      "---------------------------------------\n" +
      "Gerado em: " + new Date().toLocaleDateString('pt-BR') + " √†s " + new Date().toLocaleTimeString('pt-BR');

    setSummaryText(text);
    setIsSummaryModalOpen(true);
  };

  const copyToClipboard = () => {
    navigator.clipboard.writeText(summaryText);
    alert('Resumo copiado com sucesso!');
  };

  const [newOrder, setNewOrder] = useState<Partial<Order>>(EMPTY_ORDER);

  const handleSaveOrder = async () => {
    console.log('Validating order save:', newOrder);
    if (!newOrder.customer || !newOrder.pieceName || !newOrder.material || !newOrder.status || !newOrder.state) {
      alert('Por favor, preencha o Cliente, Nome da Pe√ßa e selecione o Material, Estado e Status do pedido.');
      return;
    }

    const qty = newOrder.quantity || 1;
    const uVal = newOrder.unitValue || 0;
    const freight = newOrder.freight || 0;
    const orderTotal = (qty * uVal) + freight;

    try {
      const savedOrder = await upsertOrder({
        ...newOrder,
        total: orderTotal
      });

      if (editingOrderId) {
        setOrders(orders.map(o => o.id === editingOrderId ? savedOrder : o));
      } else {
        setOrders([savedOrder, ...orders]);
      }
      setIsOrderModalOpen(false);
      setEditingOrderId(null);
      setNewOrder(EMPTY_ORDER);
    } catch (error) {
      console.error('Error saving order:', error);
      alert('Erro ao salvar pedido.');
    }
  };

  const handleSaveFilament = async () => {
    try {
      const saved = await upsertFilament(newFilament);
      if (editingFilamentId) {
        setFilaments(filaments.map(f => f.id === editingFilamentId ? saved : f));
      } else {
        setFilaments([saved, ...filaments]);
      }
      setIsFilamentModalOpen(false);
      setEditingFilamentId(null);
    } catch (error) {
      console.error('Error saving filament:', error);
      alert('Erro ao salvar filamento.');
    }
  };

  const handleSavePart = async () => {
    try {
      const saved = await upsertPart(newPart);
      if (editingPartId) {
        setReplacementParts(replacementParts.map(p => p.id === editingPartId ? saved : p));
      } else {
        setReplacementParts([saved, ...replacementParts]);
      }
      setIsPartModalOpen(false);
      setEditingPartId(null);
    } catch (error) {
      console.error('Error saving part:', error);
      alert('Erro ao salvar pe√ßa.');
    }
  };

  const handleEditOrder = (order: Order) => {
    setNewOrder({ ...order });
    setEditingOrderId(order.id);
    setIsOrderModalOpen(true);
  };

  const deleteOrderHandler = async (id: string) => {
    if (confirm('Deseja excluir este pedido?')) {
      try {
        await deleteOrder(id);
        setOrders(orders.filter(o => o.id !== id));
      } catch (error) {
        alert('Erro ao excluir pedido');
      }
    }
  };

  const deleteFilamentHandler = async (id: string) => {
    if (confirm('Deseja excluir este filamento?')) {
      try {
        await deleteFilament(id);
        setFilaments(filaments.filter(f => f.id !== id));
      } catch (error) {
        alert('Erro ao excluir filamento');
      }
    }
  };

  const deletePartHandler = async (id: string) => {
    if (confirm('Deseja excluir esta pe√ßa?')) {
      try {
        await deletePart(id);
        setReplacementParts(replacementParts.filter(p => p.id !== id));
      } catch (error) {
        alert('Erro ao excluir pe√ßa');
      }
    }
  };

  const updateOrderStatusHandler = async (id: string, status: OrderStatus) => {
    const order = orders.find(o => o.id === id);
    if (!order) return;
    try {
      const saved = await upsertOrder({ ...order, status });
      setOrders(orders.map(o => o.id === id ? saved : o));
      setOpenStatusDropdownId(null);
    } catch (error) {
      alert('Erro ao atualizar status');
    }
  };

  const getStatusStyle = (status: OrderStatus) => {
    switch (status) {
      case 'Or√ßamento': return 'bg-slate-100 text-slate-600';
      case 'Produ√ß√£o': return 'bg-blue-50 text-blue-600';
      case 'Finalizado':
      case 'Entregue': return 'bg-emerald-50 text-emerald-600';
      case 'Cancelado': return 'bg-rose-50 text-rose-600';
      default: return 'bg-slate-50 text-slate-600';
    }
  };

  const getProgressColor = (percentage: number) => {
    if (percentage <= 20) return 'bg-rose-500';
    if (percentage >= 60) return 'bg-emerald-500';
    return 'bg-amber-500';
  };

  const [newFilament, setNewFilament] = useState<Partial<Filament>>({ brand: '', material: 'PLA', color: '', initialWeight: 1, currentWeight: 1, costPerKg: 0, freight: 0 });
  const [newPart, setNewPart] = useState<Partial<ReplacementPart>>({ name: '', category: 'Outros', brand: '', quantity: 1, unitCost: 0, purchaseDate: new Date().toISOString().split('T')[0], notes: '' });

  const handleEditFilament = (filament: Filament) => {
    setNewFilament({ ...filament });
    setEditingFilamentId(filament.id);
    setIsFilamentModalOpen(true);
  };

  const handleEditPart = (part: ReplacementPart) => {
    setNewPart({ ...part });
    setEditingPartId(part.id);
    setIsPartModalOpen(true);
  };

  const handleSignOut = async () => {
    await supabase.auth.signOut();
  };

  if (authLoading || isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#f8fafc]">
        <div className="flex flex-col items-center gap-4">
          <div className="bg-[#0ea5e9] p-4 rounded-3xl shadow-2xl shadow-sky-200 animate-bounce">
            <Loader2 className="text-white w-10 h-10 animate-spin" />
          </div>
          <div className="flex flex-col items-center gap-1">
            <p className="text-slate-800 text-lg font-black tracking-tight">3D Print Flow</p>
            <p className="text-slate-400 text-sm font-medium animate-pulse">Sincronizando seus dados...</p>
          </div>
        </div>
      </div>
    );
  }

  if (!user) {
    return <Auth />;
  }

  return (
    <div className="min-h-screen bg-[#f8fafc] text-slate-900 pb-12 font-sans" onClick={() => {
      setOpenStatusDropdownId(null);
      setIsMaterialDropdownOpen(false);
      setIsOrderMaterialDropdownOpen(false);
      setIsStateDropdownOpen(false);
      setIsOrderStatusDropdownOpen(false);
      setIsPartCategoryDropdownOpen(false);
    }}>
      <header className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
          <div className="flex items-center gap-3">
            <div className="bg-[#0ea5e9] p-1.5 rounded-lg">
              <Printer className="text-white w-5 h-5" />
            </div>
            <h1 className="text-lg font-bold text-slate-800">3D Print Flow</h1>
          </div>

          <div className="flex bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'dashboard' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
              <LayoutDashboard className="w-3.5 h-3.5" />
              Dashboard
            </button>
            <button onClick={() => setActiveTab('calculator')} className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'calculator' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
              <Calculator className="w-3.5 h-3.5" />
              Calculadora
            </button>
            <button onClick={() => setActiveTab('orders')} className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'orders' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
              <ShoppingBag className="w-3.5 h-3.5" />
              Pedidos
            </button>
            <button onClick={() => setActiveTab('inventory')} className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'inventory' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
              <Database className="w-3.5 h-3.5" />
              Estoque
            </button>
            <button onClick={() => setActiveTab('parts')} className={`flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${activeTab === 'parts' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
              <Wrench className="w-3.5 h-3.5" />
              Pe√ßas
            </button>
          </div>

          <div className="flex items-center gap-3">
            <div className="hidden md:flex flex-col items-end">
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Usu√°rio</span>
              <span className="text-xs font-bold text-slate-600 truncate max-w-[120px]">{user.email}</span>
            </div>
            <button
              onClick={handleSignOut}
              className="p-2.5 bg-slate-50 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all"
              title="Sair"
            >
              <LogOut className="w-4 h-4" />
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {activeTab === 'dashboard' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div className="flex flex-col gap-1">
                <h2 className="text-3xl font-extrabold text-[#0f172a]">Dashboard</h2>
                <p className="text-slate-500 text-sm font-medium">Vis√£o geral financeira baseada nos pedidos salvos.</p>
              </div>
              <div className="flex items-center gap-3">
                <div className="flex bg-slate-100 p-1 rounded-xl mr-2">
                  <button
                    onClick={() => setDashboardScope('month')}
                    className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${dashboardScope === 'month' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    Mensal
                  </button>
                  <button
                    onClick={() => { setDashboardScope('year'); if (selectedMonth === -1) setSelectedMonth(currentMonth); }}
                    className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${dashboardScope === 'year' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    Anual
                  </button>
                  <button
                    onClick={() => { setDashboardScope('all'); setSelectedMonth(-1); }}
                    className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${dashboardScope === 'all' ? 'bg-white text-[#0ea5e9] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                  >
                    Geral
                  </button>
                </div>
                {(dashboardScope === 'month' || dashboardScope === 'all') && (
                  <select
                    value={selectedMonth}
                    onChange={(e) => setSelectedMonth(Number(e.target.value))}
                    className="bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-sky-500/20"
                  >
                    {dashboardScope === 'all' && <option value={-1}>Todos os Meses</option>}
                    {MONTH_NAMES.map((name, i) => <option key={name} value={i}>{name}</option>)}
                  </select>
                )}
                {dashboardScope !== 'all' && (
                  <select
                    value={selectedYear}
                    onChange={(e) => setSelectedYear(Number(e.target.value))}
                    className="bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-sky-500/20"
                  >
                    {[currentYear - 1, currentYear, currentYear + 1].map(y => <option key={y} value={y}>{y}</option>)}
                  </select>
                )}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <StatCard title="Receita Total" value={formatCurrency(metrics.totalRevenue)} icon={<DollarSign />} iconColor="text-sky-500" description={`vlr produtos (` + (dashboardScope === 'month' ? 'm√™s' : dashboardScope === 'year' ? 'ano' : 'geral') + `)`} />
              <StatCard title="Lucro L√≠quido" value={formatCurrency(metrics.totalProfit)} icon={<TrendingUp />} iconColor="text-emerald-500" valueColorClass="text-emerald-600" description={profitMarginPercent.toFixed(1) + "% de margem real"} />
              <StatCard title="Custo Produ√ß√£o" value={formatCurrency(metrics.totalCost)} icon={<Activity />} iconColor="text-rose-500" valueColorClass="text-rose-600" description="total gasto na produ√ß√£o" />
              <StatCard title="Pedidos" value={metrics.totalOrders} icon={<ShoppingBag />} iconColor="text-sky-500" description={`quantidade ` + (dashboardScope === 'month' ? 'no m√™s' : dashboardScope === 'year' ? 'no ano' : 'hist√≥rica')} />
              <StatCard title="Horas de Impress√£o" value={metrics.totalPrintingHours.toFixed(1) + "h"} icon={<Clock />} iconColor="text-orange-500" description="uso total das m√°quinas" />
              <StatCard title="Ticket M√©dio" value={formatCurrency(metrics.averageTicket)} icon={<Calculator />} iconColor="text-indigo-500" description="valor m√©dio por pedido" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <h3 className="text-lg font-bold text-slate-800 mb-6">Faturamento {dashboardScope === 'month' ? 'Di√°rio' : dashboardScope === 'year' ? 'Mensal' : 'Anual'}</h3>
                <div className="h-[300px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={metrics.dailyHistory}>
                      <defs>
                        <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#0ea5e9" stopOpacity={0.1} />
                          <stop offset="95%" stopColor="#0ea5e9" stopOpacity={0} />
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <XAxis dataKey="day" interval={1} axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 10 }} padding={{ left: 10, right: 10 }} />
                      <YAxis axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 12 }} />
                      <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} formatter={(val: number) => [formatCurrency(val), 'Faturamento']} />
                      <Area type="monotone" dataKey="revenue" stroke="#0ea5e9" strokeWidth={3} fillOpacity={1} fill="url(#colorRevenue)" />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <div className="mb-6">
                  <h3 className="text-2xl font-bold text-slate-800 leading-tight">Volume de Pedidos</h3>
                  <p className="text-slate-400 text-sm font-medium">
                    Quantidade {dashboardScope === 'month' ? `em ` + MONTH_NAMES[selectedMonth] + ` de ` + selectedYear : dashboardScope === 'year' ? `no ano de ` + selectedYear : selectedMonth === -1 ? 'Hist√≥rica Geral' : `em ` + MONTH_NAMES[selectedMonth] + ` (Todos os Anos)`}
                  </p>
                </div>
                <div className="h-[300px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={metrics.dailyHistory} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <XAxis dataKey="day" interval={1} axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 11 }} padding={{ left: 10, right: 10 }} />
                      <YAxis axisLine={false} tickLine={false} tick={{ fill: '#94a3b8', fontSize: 11 }} allowDecimals={false} domain={[0, 'auto']} />
                      <Tooltip cursor={{ fill: '#f8fafc' }} contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} formatter={(val: number) => [val, 'Pedidos']} />
                      <Bar dataKey="orders" fill="#f59e0b" radius={[4, 4, 0, 0]} barSize={12} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          </div>
        )}
